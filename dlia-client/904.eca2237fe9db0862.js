"use strict";(self.webpackChunkDLIA_client=self.webpackChunkDLIA_client||[]).push([[904],{6904:(C,y,c)=>{c.d(y,{G:()=>E});var m=c(5861),h=c(529),l=c(1135),a=c(7579),u=c(9646),n=c(3900),g=c(2340),d=c(4650),f=c(6616),P=c(3202);let v=1,E=(()=>{class _{constructor(t,e,s){this._httpClient=t,this._tokenService=e,this._locationDataService=s,this.uri=g.N.apiUrl,this.tomtomApiKey=g.N.tomtomkey,this.ipinfoToken=g.N.ipinfoToken,this.markers=new Map,this.locationsList=new l.X(void 0),this.POIs={type:"FeatureCollection",features:[]},this.SavedLocations=[],this.Pois=new Map,this.apiIds=new Set,this.removeMarker=new a.x,this.showPoi=new a.x,this.clearRP=new a.x,this.removePoiMarker=new a.x,this.diselectAllMarkers=new a.x,this.getCurrentView=new a.x,this.listPoiClick=new a.x,this.activeTomtomId="",this.activeLayer="",this.activeId=-1,this.locationFeatures=[],this.simulationId="",this.selectedLocation=new l.X(void 0),this.simulationOptions=new l.X(void 0),this.selectedLocationData=new l.X(void 0),this.degToRad=o=>o*(Math.PI/180),this.radToDeg=o=>180*o/Math.PI,this.Pois.set("restaurant",!1),this.Pois.set("hotel",!1),this.Pois.set("gas station",!1),this.Pois.set("charging station",!1),this.Pois.set("education",!1),this.Pois.set("transport",!1),this.Pois.set("work",!1),this.Pois.set("supermarket",!1),this.Pois.set("parking",!1),this.Pois.set("saved_locations",!1)}get simulationOptions$(){return this.simulationOptions}set _simulationOptions(t){this.simulationOptions.next(t)}setLocation(t){let e=[];t.properties.allConnectors&&("string"==typeof t.properties.allConnectors?(e=JSON.parse(t.properties.allConnectors),e=e.filter(s=>"StandardHouseholdCountrySpecific"!==s.connectorType)):(e=t.properties.allConnectors,e=e.filter(s=>"StandardHouseholdCountrySpecific"!==s.connectorType))),this._selectedLocation={name:t.properties.name,saved_name:t.properties.saved_name,type:t.properties.type,lon:t.geometry.coordinates[0],lat:t.geometry.coordinates[1],note:t.properties.note,address:t.properties.address,evConnector:e,apiId:t.properties.apiId,markerId:-1,city:t.properties.city},this._locationDataService.getLocationInformations(t.geometry.coordinates[0],t.geometry.coordinates[1]).subscribe({next:s=>{this._selectedLocationData=s}})}setMarkerLocation(t){this._selectedLocation={markerId:t.id,name:"pinned location",saved_name:"",type:"pinned location",lon:t.pos?.lng,lat:t.pos?.lat,note:"",address:t.name,evConnector:[],apiId:-1,city:t.city},this._locationDataService.getLocationInformations(t.pos?.lng,t.pos?.lat).subscribe({next:s=>{this._selectedLocationData=s}})}get selectedLocation$(){return this.selectedLocation}set _selectedLocation(t){this.selectedLocation.next(t)}get selectedLocationData$(){return this.selectedLocationData}set _selectedLocationData(t){this.selectedLocationData.next(t)}setSelectedLocationData(t){this.selectedLocationData.next(t)}addPoiData(t){const e=t.place;this.Pois.set(e,!0),this.getSavedLoactions(this._tokenService.getuserId(),0).subscribe({next:s=>{this._locationDataService.getPoiWithinBoundingBox(t,e).subscribe({next:o=>{o.results.forEach(i=>{this.apiIds.add(i.id);let r={type:"Feature",id:0,properties:{name:i.poi.name,address:i.address.freeformAddress,type:"supermarket"===e?"Retail":e,allConnectors:i.chargingPark&&i.chargingPark.connectors?i.chargingPark.connectors:[],saved_name:"",note:"",apiId:i.id,city:i.address.municipality},geometry:{type:"Point",coordinates:[i.position.lon,i.position.lat]}};for(let p of s)if(Math.floor(1e4*p.geometry.coordinates[0])===Math.floor(1e4*r.geometry.coordinates[0])&&Math.floor(1e4*p.geometry.coordinates[1])===Math.floor(1e4*r.geometry.coordinates[1])){r.properties.saved_name=p.properties.saved_name,r.properties.note=p.properties.note;break}r.properties.saved_name&&this.Pois.get("saved_locations")||(r.id=v++,this.POIs.features.push(r),this.locationFeatures.push(r)),-1!==this.activeId&&r.properties.apiId===this.activeTomtomId&&(this.activeId=r.id)}),t.update&&(console.log(this.locationFeatures),this.locationsList.next({type:"FeatureCollection",features:this.locationFeatures}))}})}})}filterFeatureByType(t){console.log("this is the location : ",t),this.Pois.set(t,!1);let e=this.locationsList.value.features;"supermarket"===t&&(t="Retail"),"saved_locations"===t?(this.locationFeatures=this.locationFeatures.filter(s=>!(s.properties.saved_name&&!this.Pois.get(s.properties.type))),e=e.filter(s=>!(s.properties.saved_name&&!this.Pois.get(s.properties.type))),this.locationsList.next({type:"FeatureCollection",features:e})):(console.error("this is the value ",this.Pois.get("saved_locations")),this.locationFeatures=this.locationFeatures.filter(s=>s.properties.type!==t||!(!s.properties.saved_name||!this.Pois.get("saved_locations"))),e=e.filter(s=>s.properties.type!==t||!(!s.properties.saved_name||!this.Pois.get("saved_locations"))),this.locationsList.next({type:"FeatureCollection",features:e}))}setLocationdListFeatures(t){this.locationsList.next({type:"FeatureCollection",features:t}),v=1}get locationsList$(){return this.locationsList}updatePoiView(t){var e=this;return(0,m.Z)(function*(){if(Array.from(e.Pois.values()).every(L=>!1===L))return(0,u.of)(!1);e.locationFeatures=[];let s=e.locationsList.value.features;e.apiIds.clear(),console.log("before :",e.locationFeatures);for(const[L,I]of e.Pois.entries())"saved_locations"!==L&&I&&(t.place=L,t.update=!1,e.addPoiData(t),yield new Promise(M=>setTimeout(M,500)));console.log("after  :",e.locationFeatures);let o=[];const{topLeftLat:r,topLeftLon:p,btmRightLat:D,btmRightLon:O}=t;return s.forEach(L=>{const I=L.geometry.coordinates[1],M=L.geometry.coordinates[0];I>=D&&I<=r&&M>=p&&M<=O&&!e.apiIds.has(L.properties.apiId)&&o.push(L)}),e.setLocationdListFeatures([...e.locationFeatures,...o]),(0,u.of)(!0)})()}addmarkers(t){this.markers.set(t.id,t),console.log(this.markers)}changemarkerpos(t,e){this.markers.get(e).pos=t}reverseGeo(t,e,s){const o=(new h.WM).set("excludeInterceptor","true");this._httpClient.get(`https://api.tomtom.com/search/2/reverseGeocode/${t},${e}.json?key=${this.tomtomApiKey}`,{headers:o}).subscribe({next:i=>{console.error("this is the location from the marker :",i),this.markers.get(s).name=i.addresses[0].address.freeformAddress,this.markers.get(s).city=i.addresses[0].address.municipality,this.displayInPoi(s)}})}getPoiNearby(t,e,s,o,i){const r=(new h.WM).set("excludeInterceptor","true");return this._httpClient.get(`https://api.tomtom.com/search/2/categorySearch/${t}.json?key=${this.tomtomApiKey}&typeahead=true&limit=100&topLeft=${i.topLeftLat},${i.topLeftLon}&btmRight=${i.btmRightLat},${i.btmRightLon}&minFuzzyLevel=1&language=en-GB`,{headers:r})}displayInPoi(t){console.error("this is the marker",this.markers.get(t)),this.setMarkerLocation(this.markers.get(t))}deleteMarker(t){this.removeMarker.next(t),this.markers.delete(t),console.log(this.markers)}getSimulations(t){return this._httpClient.get(this.uri+`/v1/user/simulations/${t}`)}getPOINearby(t,e,s,o){const i=(new h.WM).set("excludeInterceptor","true");return this._httpClient.get(`https://api.tomtom.com/search/2/search/${t}.json?key=${this.tomtomApiKey}&limit=50&lat=${e}&lon=${s}&radius=${o}&sortBy=distance:asc`,{headers:i})}getEvStats(t,e){return this.getPOINearby("charging station",t,e,500).pipe((0,n.w)(s=>{let o=0;return console.log(s.results),s.results.forEach(r=>{o+=r?.chargingPark?.connectors?r.chargingPark.connectors.length:0}),(0,u.of)([s.results.length,o])}))}getSavedLoactions(t,e){return 1===e&&this.Pois.set("saved_locations",!0),this._httpClient.get(this.uri+`/v1/user/locations/${t}`).pipe((0,n.w)(s=>{let o=[];return console.log(s),s.forEach(i=>{let r={type:"Feature",id:0,properties:{name:"pinned location"===i.type_location?"pinned location":i.name,saved_name:i.saved_name,type:i.type_location,note:i.note,address:i.name,evConnector:[],apiId:"",markerId:-1},geometry:{type:"Point",coordinates:[i.long,i.lat]}};r.id=v++,o.push(r),1===e&&!this.Pois.get(r.properties.type)&&this.locationFeatures.push(r)}),1===e&&this.setLocationdListFeatures([...this.locationFeatures]),(0,u.of)(o)}))}getIrisDetail(t,e){return this._httpClient.get(this.uri+`/v1/user/geo-data/iris/iris-details?lon=${t}&lat=${e}`).pipe((0,n.w)(s=>s))}getEvShare(t,e){return this._httpClient.get(this.uri+`/v1/user/geo-data/commune/commune-details/ev-share?lon=${e}&lat=${t}`).pipe((0,n.w)(s=>s))}getEvNearbyPower(t,e,s){return this._httpClient.get(this.uri+`/v1/user/geo-data/stations/charge-points-distribution?lon=${e}&lat=${t}&radius=${s}`).pipe((0,n.w)(o=>{let i={Slow:0,Regular:0,Fast:0,"Very fast":0};return o.forEach(r=>{+r.puissance_<11?i.Slow++:+r.puissance_<43?i.Regular++:+r.puissance_<80?i.Fast++:+r.puissance_>80&&i["Very fast"]++}),(0,u.of)(i)}))}getDataFromIP(){const t=(new h.WM).set("excludeInterceptor","true");return this._httpClient.get(`https://ipinfo.io?token=${this.ipinfoToken}`,{headers:t}).pipe((0,n.w)(e=>(0,u.of)(e)))}getPotentialScoreHeatmaps(t){return this._httpClient.post(this.uri+"/v1/user/geo-data/iris/potential-score",t).pipe((0,n.w)(e=>(0,u.of)(e)))}getPopulationDensityHeatmaps(t){return this._httpClient.post(this.uri+"/v1/user/geo-data/grid/population-density",t).pipe((0,n.w)(e=>(0,u.of)(e)))}getPopulationRevenueHeatmaps(t){return this._httpClient.post(this.uri+"/v1/user/geo-data/grid/avg-revenu",t).pipe((0,n.w)(e=>(0,u.of)(e)))}getEvRegistrationsHeatmaps(t){return this._httpClient.post(this.uri+"/v1/user/geo-data/communes/ev-count",t).pipe((0,n.w)(e=>(0,u.of)(e)))}getChargePointsHeatmaps(t){return this._httpClient.post(this.uri+"/v1/user/geo-data/iris/charge-points",t).pipe((0,n.w)(e=>(0,u.of)(e)))}getStats(t,e,s,o){return this._httpClient.get(this.uri+`/v1/user/geo-data/area_stats/?lon=${t}&lat=${e}&POI_score=${s}&competition_score=${o}`).pipe((0,n.w)(i=>(0,u.of)(i)))}deselectAllPois(){for(let[t,e]of this.Pois)this.Pois.set(t,!1)}SaveLocation(t){let e={name:this.selectedLocation.value.name,saved_name:t.name,type_location:this.selectedLocation.value.type,long:this.selectedLocation.value.lon,lat:this.selectedLocation.value.lat,note:t.description,location_source:"saved_location",site_attractiveness_score:this.selectedLocationData.value.siteAttractiviness.siteScore,population_densit:this.selectedLocationData.value.areaStats.populationDensity,median_revenue:this.selectedLocationData.value.areaStats.medianIncome,nearby_POIs_count:this.selectedLocationData.value.poiNearby.length,competition_count:this.selectedLocationData.value.evChargePointStats.chargingPoints,ev_registration:this.selectedLocationData.value.evChargePointStats.evShare,location_address:this.selectedLocation.value.address,ev_connectors:JSON.stringify(this.selectedLocation.value.evConnector),user_id:this._tokenService.getuserId()};return this._httpClient.post(this.uri+"/v1/user/locations",e).pipe((0,n.w)(s=>{let o=this.selectedLocation.value;return o.saved_name=t.name,o.note=t.description,this._selectedLocation=o,(0,u.of)(s)}))}}return _.\u0275fac=function(t){return new(t||_)(d.LFG(h.eN),d.LFG(f.B),d.LFG(P._))},_.\u0275prov=d.Yz7({token:_,factory:_.\u0275fac,providedIn:"root"}),_})()},3202:(C,y,c)=>{c.d(y,{_:()=>E});var m=c(529),h=c(3900),l=c(9646),a=c(4128),u=c(262),n=c(6170),g=c(2340),d=c(4650),f=c(7009);function P(_){return _*(Math.PI/180)}function v(_,S,t,e){const o=P(_),i=P(t),r=P(t-_),p=P(e-S),D=Math.sin(r/2)*Math.sin(r/2)+Math.cos(o)*Math.cos(i)*Math.sin(p/2)*Math.sin(p/2),O=2*Math.atan2(Math.sqrt(D),Math.sqrt(1-D));return Math.floor(6371e3*O)}let E=(()=>{class _{constructor(t,e){this._httpClient=t,this.snackBar=e,this.tomtomApiKey=g.N.tomtomkey,this.uri=g.N.apiUrl}getReverseGeocode(t,e){const s=(new m.WM).set("excludeInterceptor","true");return this._httpClient.get(`https://api.tomtom.com/search/2/reverseGeocode/${e},${t}.json?key=${this.tomtomApiKey}`,{headers:s})}getPoiNearby(t,e,s,o){const i=(new m.WM).set("excludeInterceptor","true");return this._httpClient.get(`https://api.tomtom.com/search/2/search/${o}.json?key=${this.tomtomApiKey}&limit=50&lat=${e}&lon=${t}&radius=${s}&sortBy=distance:asc`,{headers:i})}getChargingStationsNearby(t,e,s){return this.getPoiNearby(t,e,s,"charging station").pipe((0,h.w)(o=>{let i=0;return console.log(o.results),o.results.forEach(p=>{i+=p?.chargingPark?.connectors?p.chargingPark.connectors.length:0}),(0,l.of)([o.results.length,i])}))}getNumberOfEvsNearby(t,e,s){return this._httpClient.get(this.uri+`/v1/user/geo-data/commune/commune-details/ev-share?lon=${t}&lat=${e}`).pipe((0,h.w)(o=>o))}getAttractivenessScoresAreaStats(t,e,s,o){return this._httpClient.get(this.uri+`/v1/user/geo-data/area_stats/?lon=${t}&lat=${e}&POI_score=${s}&competition_score=${o}`).pipe((0,h.w)(i=>(0,l.of)(i)))}getHeatmapPolygons(t,e){return(0,l.of)(!0)}getChargePointsDistribution(t,e,s){return this._httpClient.get(this.uri+`/v1/user/geo-data/stations/charge-points-distribution?lon=${t}&lat=${e}&radius=${s}`).pipe((0,h.w)(o=>{let i={Slow:0,Regular:0,Fast:0,"Very fast":0};return o.forEach(r=>{+r.puissance_<11?i.Slow++:+r.puissance_<43?i.Regular++:+r.puissance_<80?i.Fast++:+r.puissance_>80&&i["Very fast"]++}),(0,l.of)(i)}))}getPoiWithinBoundingBox(t,e){const s=(new m.WM).set("excludeInterceptor","true");return this._httpClient.get(`https://api.tomtom.com/search/2/categorySearch/${e}.json?key=${this.tomtomApiKey}&typeahead=true&limit=100&topLeft=${t.topLeftLat},${t.topLeftLon}&btmRight=${t.btmRightLat},${t.btmRightLon}&minFuzzyLevel=1&language=en-GB`,{headers:s})}getNearbyPoi(t,e){return(0,a.D)([this.getPoiNearby(t,e,300,"hotel"),this.getPoiNearby(t,e,300,"restaurant"),this.getPoiNearby(t,e,300,"shopping center")]).pipe((0,u.K)(()=>(0,l.of)(!1)),(0,h.w)(([s,o,i])=>{let r=[];return s.results.forEach(p=>{r.push({name:p?.poi?.name,type:"hotel",distance:v(e,t,p.position.lat,p.position.lon)})}),o.results.forEach(p=>{r.push({name:p?.poi?.name,type:"restaurant",distance:v(e,t,p.position.lat,p.position.lon)})}),i.results.forEach(p=>{r.push({name:p?.poi?.name,type:"shopping_cart",distance:v(e,t,p.position.lat,p.position.lon)})}),r.sort((p,D)=>p.distance-D.distance),(0,l.of)(r)}))}getEvStats(t,e){return(0,a.D)([this.getChargingStationsNearby(t,e,500),this.getNumberOfEvsNearby(t,e,500),this.getChargePointsDistribution(t,e,500)]).pipe((0,u.K)(()=>(0,l.of)(!1)),(0,h.w)(([s,o,i])=>(0,l.of)({chargingPoints:s[1],chargingStation:s[0],evShare:o.ev_registr,evStatsChartValues:[i.Slow,i.Regular,i.Fast,i["Very fast"]]})))}getStats(t,e,s,o){return this._httpClient.get(this.uri+`/v1/user/geo-data/area_stats/?lon=${t}&lat=${e}&POI_score=${s}&competition_score=${o}`).pipe((0,h.w)(i=>(0,l.of)(i)))}getAgeDistribution(t,e){return this._httpClient.get(this.uri+`/v1/user/geo-data/grid/age-distribution?lon=${t}&lat=${e}`).pipe((0,h.w)(s=>(console.log("this is the age distro: ",s),(0,l.of)(s))))}getLocationInformations(t,e){let s={poiNearby:[],evChargePointStats:{},areaStats:{areaScore:-1,medianIncome:-1,populationDensity:-1,ageDistribution:[]},siteAttractiviness:{siteScore:0,evUptake:0,populationDensityScore:0,populationAvgRevenueScore:0,nearbyCompetitionScore:0,nearbyPointOfInterestScore:0}};return(0,a.D)([this.getNearbyPoi(t,e),this.getEvStats(t,e),this.getAgeDistribution(t,e)]).pipe((0,h.w)(([o,i,r])=>(s.poiNearby=o,s.evChargePointStats=i,s.areaStats.ageDistribution=[r[0].ind_18_24,r[0].ind_25_39,r[0].ind_40_54,r[0].ind_55_64,r[0].ind_65_79,r[0].ind_80p],this.getStats(t,e,o.length,i.chargingPoints))),(0,h.w)(o=>(s.areaStats.areaScore=o.area_stats[0].score,s.areaStats.medianIncome=o.area_stats[0].avg_revenu,s.areaStats.populationDensity=o.area_stats[0].pop_densit,s.siteAttractiviness.siteScore=o.score,s.siteAttractiviness.evUptake=o.ev_score,s.siteAttractiviness.populationDensityScore=o.pop_den_score,s.siteAttractiviness.populationAvgRevenueScore=o.pop_revenu_score,s.siteAttractiviness.nearbyCompetitionScore=o.competition_score,s.siteAttractiviness.nearbyPointOfInterestScore=o.POI_score,(0,l.of)(s))),(0,u.K)(o=>(console.error(o),this.snackBar.openFromComponent(n.u,{data:{coloredMessage:"Data is not available yet",message:"for this region, we are working on it"},duration:4e3,panelClass:["bg-white"],horizontalPosition:"center",verticalPosition:"bottom",politeness:"assertive"}),(0,l.of)(s))))}getLocationFromSimulationId(t){return this._httpClient.get(this.uri+`/v1/user/simulations/location-details/${t}`).pipe((0,h.w)(e=>(0,l.of)(e)))}}return _.\u0275fac=function(t){return new(t||_)(d.LFG(m.eN),d.LFG(f.ux))},_.\u0275prov=d.Yz7({token:_,factory:_.\u0275fac,providedIn:"root"}),_})()},6616:(C,y,c)=>{c.d(y,{B:()=>l});var m=c(4650),h=c(8386);let l=(()=>{class a{constructor(n){this.userService=n}saveSession(n){window.localStorage.setItem("AT",n.accessToken)}getSession(){return window.localStorage.getItem("accessToken")?{accessToken:window.localStorage.getItem("accessToken")||""}:null}logout(){window.localStorage.clear()}isLoggedIn(){let n=this.getSession();if(!n)return!1;const g=JSON.parse(atob(n.accessToken.split(".")[1]));return!(Date.now()>1e3*g.exp)}getuserId(){let n=this.getSession();return JSON.parse(atob(n.accessToken.split(".")[1])).id}}return a.\u0275fac=function(n){return new(n||a)(m.LFG(h.K))},a.\u0275prov=m.Yz7({token:a,factory:a.\u0275fac,providedIn:"root"}),a})()},6170:(C,y,c)=>{c.d(y,{u:()=>u});var m=c(6895),h=c(7392),l=c(7009),a=c(4650);let u=(()=>{class n{constructor(d){this.data=d}}return n.\u0275fac=function(d){return new(d||n)(a.Y36(l.qD))},n.\u0275cmp=a.Xpm({type:n,selectors:[["app-limited-display-snackbar"]],standalone:!0,features:[a.jDz],decls:7,vars:2,consts:[[1,"flex","items-center","justify-start","m-0","p-0"],[1,"mr-2",2,"color","#df9817"],[2,"color","#2c3e50"],[2,"color","#df9817"]],template:function(d,f){1&d&&(a.TgZ(0,"div",0)(1,"mat-icon",1),a._uU(2,"info"),a.qZA(),a.TgZ(3,"span",2)(4,"span",3),a._uU(5),a.qZA(),a._uU(6),a.qZA()()),2&d&&(a.xp6(5),a.Oqu(f.data.coloredMessage),a.xp6(1),a.hij(" ",f.data.message,""))},dependencies:[m.ez,h.Ps,h.Hw],encapsulation:2}),n})()},5861:(C,y,c)=>{function m(l,a,u,n,g,d,f){try{var P=l[d](f),v=P.value}catch(E){return void u(E)}P.done?a(v):Promise.resolve(v).then(n,g)}function h(l){return function(){var a=this,u=arguments;return new Promise(function(n,g){var d=l.apply(a,u);function f(v){m(d,n,g,f,P,"next",v)}function P(v){m(d,n,g,f,P,"throw",v)}f(void 0)})}}c.d(y,{Z:()=>h})}}]);